# 智能运维引擎工作流设计 (简化可视化编排版)

本设计以“低门槛、高效率”为目标，将工作流编排页简化为可视化步骤列表。默认只暴露必须信息 (环境变量与主机)，其他复杂配置逐层折叠或隐藏在高级面板。

## 1. 目标与原则
- 低门槛: 新手不需要写 YAML 即可完成脚本/命令型工作流。
- 渐进呈现: 先展示最少字段，更多能力在“高级配置/高级编辑器”中展开。
- 线性执行: 工作流保持顺序步骤模型，每一步对目标主机并发完成后再进入下一步。
- 可视化为主: 以步骤卡片为核心，避免让用户直接面对 YAML。
- 一键运行: plan/apply 仅在工作流编排页提供，失败信息清晰定位到步骤。

## 2. 页面结构 (工作流编排页)
### 2.1 顶部区域 (全局信息)
- 工作流名称、描述。
- 运行环境变量包 (env_packages) 显式选择 (可选)。
- 主机/分组管理入口 (Inventory 管理弹窗)。
- 高级编辑器入口 (折叠的 YAML 面板，默认隐藏)。

### 2.2 中心区域 (步骤列表)
- 列表式步骤卡片，支持拖拽排序。
- 每个步骤卡片包含:
  - 步骤名称
  - 目标主机/分组
  - 动作类型 (基础动作优先)
  - 动作参数 (由动作类型决定)
  - 高级配置折叠区 (默认收起)
- 列表底部提供“新增步骤”按钮。

### 2.3 右侧/底部区域 (辅助信息)
- 结构预览 (可选开关)。
- 错误与校验提示 (按步骤显示)。
- YAML 预览 (只读，默认隐藏)。

## 3. 动作类型与可视化配置
### 3.1 基础动作 (默认展示)
- cmd.run: 执行命令
  - 字段: cmd (输入框/多行), dir (可选), env (默认隐藏，可展开)
- script.shell: 运行 shell 脚本
  - 字段: script (多行文本) 或 script_ref (脚本库选择，二选一)
  - args (可选), env (默认隐藏，可展开), dir (可选)
- script.python: 运行 python 脚本
  - 字段: script (多行文本) 或 script_ref (脚本库选择，二选一)
  - args (可选), env (默认隐藏，可展开), dir (可选)

说明: 如果用户只使用 cmd.run 与 script.*，仅需基础表单即可完成编排。

### 3.2 高级动作 (折叠显示)
- template.render
- pkg.install
- service.ensure / service.restart
- env.set (可用于设置后续步骤依赖的运行期变量)

## 4. 步骤卡片设计
每个步骤卡片分为四块:
1) 标题区: 序号 + 步骤名 + 状态提示
2) 目标区: 选择 host/group, 支持多选
3) 动作区: 动作类型选择 + 参数表单
4) 高级区 (折叠): when / retries / timeout / loop / notify / env (默认隐藏，可按钮展开)

交互细节:
- 步骤间拖拽重排。
- 复制/删除步骤。
- 一键转换为“高级动作”。
- 表单出错时高亮字段，不阻止用户继续编辑。

## 5. YAML 与可视化的映射
### 5.1 映射原则
- UI 表单是主视图，YAML 仅作高级编辑与导出。
- YAML 修改后可同步回 UI (若包含 UI 未支持字段，提示并引导用户去原来的 YAML 编辑器修改)。

### 5.2 示例映射
UI 表单 (cmd.run):
- step.name = "check disk"
- step.targets = ["web"]
- step.action = "cmd.run"
- step.with.cmd = "df -h"

对应 YAML:
```yaml
- name: check disk
  targets: [web]
  action: cmd.run
  with:
    cmd: "df -h"
```

## 6. 主机与环境变量
### 6.1 主机管理
- 主机/分组独立管理弹窗 (必须支持分组)。
- 支持 IP、地址、分组、主机变量。
- 在步骤中以“目标选择器”引用。

### 6.2 环境变量
- 全局 env_packages 显式选择 (运行时注入)。
- 步骤级 env 覆盖 (默认隐藏，按钮展开查看)。
- env.set 提供可视化表单 (键值对)。

## 7. 执行与反馈
- Plan/Apply 按钮只放在工作流编排页顶部 (不分散在其它页面)。
- 运行控制台显示完整步骤列表与状态 (成功/失败/排队)。
- 失败提示回链到对应步骤卡片。
- 默认策略: 任一主机失败即终止后续步骤。

## 8. 兼容高级模式
- 高级编辑器内可直接编辑 YAML。
- YAML 中包含 UI 未支持动作时:
  - UI 显示提示
  - 引导用户到原来的 YAML 编辑器进行文本修改

## 9. 渐进优化方向
- 模板库/脚本库快捷插入。
- 步骤模板市场 (一键插入常用运维步骤)。
- AI 对话生成步骤后自动填充列表。
