# Runner 异常场景与处理建议

本文档用于梳理 runner 在运行阶段可能遇到的异常场景，并给出当前行为与建议的解决方案。  
重点覆盖：失败处理、变量缺失、条件执行、长任务、Agent 重启与其他高风险边界。

---

## 1) 某个步骤失败，是否还要继续跑？

**当前行为**
- 任一 step 执行失败，整个 workflow 立即失败并停止（见 `executor.Run`）。

**建议方案**
- 增加 `continue_on_error: true`（step 级别）允许失败后继续。


---

## 2) 步骤成功但没输出所需参数/指标怎么办？

**当前行为**
- 只有 `with.export_vars: true` + `BOPS_EXPORT:{key=value}` 才会导出变量。
- 如果未导出，后续步骤不会报错（除非脚本自行校验）。

**建议方案**
- 增加 `expect_vars: [A,B,C]`（step 级别）校验导出变量，否则失败。

---

## 3) 根据变量值分支执行 / 跳过步骤

**当前行为**
- `when` 仅支持 `true/false/yes/no`，不支持表达式与变量。

**建议方案**
- 扩展 `when` 为表达式（如 `when: ${BACKUP_OK} == ""`）。

---

## 4) 长时间任务如何管理？

**当前行为**
- 同步 HTTP 调用，受 client timeout 限制。
- 支持 `timeout`/`retries`，但没有实时进度回传。

**建议方案**
- 引入异步执行,agent每次执行的时候,如果超过4秒没执行结束并返回,就把任务转成异步任务,返回taskid,不断去轮询执行情况

---

## 5) 长任务过程中 Agent 重启怎么办？

**当前行为**
- 没有任务持久化，Agent 重启将导致任务中断。
- Dispatcher 仅做 pre-flight heartbeat。

---

## 6) 网络抖动/Agent 不可达

**当前行为**
- Dispatcher heartbeat 失败直接报错。
- Dispatch 有重试，但无指数退避。

---

## 7) 多目标并发执行的变量冲突

**当前行为**
- 多 host 并发时，导出变量可能互相覆盖（最后写入覆盖前写入）。


---

## 8) 任务取消/暂停/恢复

**当前行为**
- 不支持取消，仅依赖 context cancel。

**建议方案**
- 增加 run 控制 API：`cancel`。
- Executor 接收控制信号并在 step 边界安全停机。

---

## 9) 输出过大导致内存与日志压力

**当前行为**
- stdout/stderr 全量缓存，日志输出可能过大。

**建议方案**
- 增加 `max_output_bytes` 并截断。
- stdout/stderr 支持落盘存储（artifact store）。


### 小结
当前 runner 已能完成基础流程，但对“长任务、故障恢复、条件分支、强校验、可观测”仍需增强。  
建议优先级：**异步长任务 + 变量校验 + 条件表达式 + 任务持久化/恢复**。

